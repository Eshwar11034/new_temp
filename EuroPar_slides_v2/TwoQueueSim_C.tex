% Simulation Slide 3: Parallel Work and the Wait Queue
\begin{frame}{Simulation: The Two-Queue Scheduler in Action}
  \begin{columns}[c,onlytextwidth]

    % --- LEFT: Text that updates with each step of the animation ---
    \column{0.4\textwidth}
    \begin{alertblock}<1-2>{State C: Parallel Dequeue}
      With multiple ready tasks available, several idle threads (\textbf{T2, T3, T4}) dequeue tasks from the \textbf{front} of the Main Queue to execute in parallel.
    \end{alertblock}
    
    \begin{alertblock}<3-4>{State D: Dependency Fails}
      \textbf{T2} finishes $T_{1,2}$ and enqueues its child, $T_{2,2}$. Another thread, \textbf{T5}, dequeues $T_{2,3}$.
      \vspace{1mm}
      However, its parent $T_{2,2}$ is not yet complete. The dependency check \alert{fails}, and $T_{2,3}$ is moved to the \textbf{Wait Queue}.
    \end{alertblock}

    \begin{alertblock}<5->{State E: Promotion}
      After other threads finish their work (e.g., $T_{2,2}$ completes), a thread checks the Wait Queue.
      \vspace{1mm}
      It finds that $T_{2,3}$'s dependencies are now met. The task is \alert{promoted} back to the Main Queue, ready for execution.
    \end{alertblock}

    % --- RIGHT: The diagram that animates through the states ---
    \column{0.6\textwidth}
    \centering
    \begin{tikzpicture}[font=\scriptsize, every node/.style={transform shape}, scale=0.95]
      % Styles
      \tikzset{pool/.style={draw, thick, ellipse, fill=accent!15, minimum width=2.8cm, minimum height=2cm, align=center}}
      \tikzset{thread_icon/.style={draw, circle, fill=accent!30, minimum size=0.5cm}}
      \tikzset{active_thread/.style={thread_icon, fill=accent!60, text=white, minimum size=0.6cm}}
      \tikzset{task_ready/.style={draw, rectangle, rounded corners=1pt, fill=updategreen!70, minimum width=1cm, minimum height=0.6cm}}
      \tikzset{task_wait/.style={draw, rectangle, rounded corners=1pt, fill=gray!50, minimum width=1cm, minimum height=0.6cm}}
      \tikzset{task_pivot/.style={task_ready, fill=pivotblue!70, text=white}}
      \tikzset{queue_box/.style={draw, thick, fill=gray!10}}
      
      % --- Static Elements ---
      \node[pool] (pool) at (3.5, 0) {}; \node[anchor=north] at (pool.south) {Thread Pool};
      \node[anchor=south] at (-0.5, 2.5) {Main Queue}; \draw[queue_box] (-3, 1.8) rectangle (2, 2.4);
      \node[font=\tiny] at (-3, 1.5) {(Front)}; \node[font=\tiny] at (2, 1.5) {(Rear)};
      \node[anchor=south] at (-0.5, -1.5) {Wait Queue}; \draw[queue_box] (-3, -2.2) rectangle (2, -1.6);
      \node[font=\tiny] at (-3, -2.5) {(Front)}; \node[font=\tiny] at (2, -2.5) {(Rear)};

      % --- ANIMATION SEQUENCE ---

      % STATE C: Parallel Dequeue
      \node<1>[task_ready] at (1.5, 2.1) {$T_{1,4}$};
      \node<1>[task_ready] at (0.4, 2.1) {$T_{1,3}$};
      \node<1>[task_ready] at (-0.7, 2.1) {$T_{1,2}$};
      \draw<2>[-{Stealth}, thick] (-0.7, 1.8) -- (-0.7, 0.5); % T2 takes T1,2
      \draw<2>[-{Stealth}, thick] (0.4, 1.8) -- (0.4, 0.5);  % T3 takes T1,3
      \draw<2>[-{Stealth}, thick] (1.5, 1.8) -- (1.5, 0.5);  % T4 takes T1,4
      \node<2->[thread_icon] at ($(pool.center)+(0, -0.7)$) {\tiny T1};
      \node<2->[active_thread] at (-0.7, 0) {\tiny T2};
      \node<2->[active_thread] at (0.4, 0) {\tiny T3};
      \node<2->[active_thread] at (1.5, 0) {\tiny T4};
      \node<2->[thread_icon] at ($(pool.center)+(1.1, -0.3)$) {\tiny T5};
      
      % STATE D: Dependency Fails
      \node<3->[task_pivot] at (1.5, 2.1) {$T_{2,2}$}; % T2 spawns T2,2
      \node<3->[task_ready] at (0.4, 2.1) {$T_{2,3}$}; % T3 spawns T2,3
      \draw<4>[-{Stealth}, thick] (0.4, 1.8) -- (0.4, -0.8); % T5 takes T2,3
      \node<4->[active_thread] at (0.4, -1.1) {\tiny T5};
      \draw<4>[-{Stealth}, thick, depred] (0.4, -1.1) -- node[right, pos=0.2] {Check Fails!} (0.4, -1.6);
      \node<4->[task_wait] at (1.5, -1.9) {$T_{2,3}$};
      
      % STATE E: Promotion
      % T2,2 is dequeued and completes (implicitly)
      \node<5->[task_wait] at (-2.5, -1.9) {$T_{2,3}$};
      \draw<5>[-{Stealth}, thick, updategreen] (-2.5, -1.6) to[bend left=60] node[left] {Promote} (2, 2.1);
      \node<5->[task_ready] at (1.5, 2.1) {$T_{2,3}$};

    \end{tikzpicture}
  \end{columns}
\end{frame}